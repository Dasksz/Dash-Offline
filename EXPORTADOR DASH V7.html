        function updateCityView() {
            const supervisor = citySupervisorFilter.value;
            const codcliFilterVal = cityCodCliFilter.value.trim();
            if (codcliFilterVal && !allClientsData.some(c => String(c['Código']) === codcliFilterVal)) return;
            let clientsForAnalysis = getRelevantClientsForCityFilter();
            const allAvailableCities = [...new Set(clientsForAnalysis.map(c => c.cidade).filter(Boolean))];
            const cidadeFiltroInput = cityNameFilter.value.trim();
            let cidadeFiltro = '';
            if (cidadeFiltroInput && allAvailableCities.includes(cidadeFiltroInput)) cidadeFiltro = cidadeFiltroInput;

            const referenceDate = lastSaleDate;
            const currentMonth = referenceDate.getMonth();
            const currentYear = referenceDate.getFullYear();

            let salesForAnalysis = allSalesData;

            const clientCodesForAnalysis = new Set(clientsForAnalysis.map(c => c['Código']));
            salesForAnalysis = salesForAnalysis.filter(s => clientCodesForAnalysis.has(s.CODCLI));

            if (supervisor) salesForAnalysis = salesForAnalysis.filter(s => s.SUPERV === supervisor);
            if (selectedCitySellers.length > 0) salesForAnalysis = salesForAnalysis.filter(s => selectedCitySellers.includes(s.NOME));
            if (selectedCityTiposVenda.length > 0) salesForAnalysis = salesForAnalysis.filter(s => selectedCityTiposVenda.includes(s.TIPOVENDA));

            if (cidadeFiltro) { clientsForAnalysis = clientsForAnalysis.filter(c => c.cidade && c.cidade === cidadeFiltro); salesForAnalysis = salesForAnalysis.filter(s => s.CIDADE && s.CIDADE === cidadeFiltro); }
            if (codcliFilterVal) { clientsForAnalysis = clientsForAnalysis.filter(c => String(c['Código']) === codcliFilterVal); salesForAnalysis = salesForAnalysis.filter(s => s.CODCLI === codcliFilterVal); }

            const salesThisMonth = allSalesData.filter(sale => {
                const saleDate = parseDate(sale.DTPED);
                return saleDate && saleDate.getFullYear() === currentYear && saleDate.getMonth() === currentMonth;
            });

            const clientTotalsThisMonth = new Map();
            salesThisMonth.forEach(sale => {
                const codcli = sale.CODCLI;
                const currentTotal = clientTotalsThisMonth.get(codcli) || 0;
                clientTotalsThisMonth.set(codcli, currentTotal + sale.VLVENDA);
            });

            let activeClientsList = [];
            let inactiveClientsList = [];

            clientsForAnalysis.forEach(client => {
                const codcli = String(client['Código']);
                if (codcli === '6720' || client.bloqueio === 'S') return;

                const registrationDate = parseDate(client.dataCadastro);
                client.isNew = registrationDate && registrationDate.getMonth() === currentMonth && registrationDate.getFullYear() === currentYear;

                const totalFaturamentoMes = clientTotalsThisMonth.get(codcli) || 0;

                if (totalFaturamentoMes > 0) {
                    activeClientsList.push(client);
                } else {
                    if (totalFaturamentoMes < 0) {
                        client.isReturn = true;
                    }
                    const clientRcas = client.rcas || [];
                    if (clientRcas.length > 0 && clientRcas.every(rca => rca === '53')) return;
                    client.isNewForInactiveLabel = client.isNew && !parseDate(client.ultimaCompra);
                    inactiveClientsList.push(client);
                }
            });

            inactiveClientsForExport = inactiveClientsList;

            if (clientsForAnalysis.length > 0) {
                 const statusChartOptions = { animation: { duration: 800, easing: 'easeOutQuart' }, plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } }, tooltip: { callbacks: { label: function(context) { return context.label; } } }, datalabels: { formatter: (value, ctx) => { const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); if (total === 0 || value === 0) return ''; const percentage = (value * 100 / total).toFixed(1) + "%"; return `${value}\n(${percentage})`; }, color: '#fff', font: { weight: 'bold' }, textAlign: 'center' } } };
                createChart('customerStatusChart', 'doughnut', ['Ativos no Mês', 'S/ Vendas no Mês'], [activeClientsList.length, inactiveClientsList.length], statusChartOptions);
            } else showNoDataMessage('customerStatusChart', 'Sem clientes no filtro para exibir o status.');

            const salesByActiveClient = {};
            activeClientsList.forEach(client => {
                const codcli = String(client['Código']);
                let clientSales = salesThisMonth.filter(s => s.CODCLI === codcli);

                if (selectedCitySellers.length > 0) {
                    clientSales = clientSales.filter(s => selectedCitySellers.includes(s.NOME));
                }

                const totalFaturamentoFiltrado = clientSales.reduce((sum, s) => sum + s.VLVENDA, 0);

                if (totalFaturamentoFiltrado > 0) {
                    const pepsicoTotal = clientSales.filter(s => s.OBSERVACAOFOR === 'PEPSICO').reduce((sum, s) => sum + s.VLVENDA, 0);
                    const multimarcasTotal = clientSales.filter(s => s.OBSERVACAOFOR === 'MULTIMARCAS').reduce((sum, s) => sum + s.VLVENDA, 0);
                    const outrosTotal = totalFaturamentoFiltrado - pepsicoTotal - multimarcasTotal;
                    salesByActiveClient[codcli] = { ...client, total: totalFaturamentoFiltrado, pepsico: pepsicoTotal, multimarcas: multimarcasTotal, outros: outrosTotal };
                }
            });

            const sortedActiveClients = Object.values(salesByActiveClient).sort((a, b) => b.total - a.total);
            activeClientsForExport = sortedActiveClients;
            cityActiveDetailTableBody.innerHTML = sortedActiveClients.map(data => {
                const novoLabel = data.isNew ? `<span class="ml-2 text-xs font-semibold text-purple-400 bg-purple-900/50 px-2 py-0.5 rounded-full">NOVO</span>` : '';
                let tooltipParts = [];
                if (data.pepsico > 0) tooltipParts.push(`PEPSICO: ${data.pepsico.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`);
                if (data.multimarcas > 0) tooltipParts.push(`MULTIMARCAS: ${data.multimarcas.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`);
                if (data.outros > 0.001) tooltipParts.push(`OUTROS: ${data.outros.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`);
                const tooltipText = tooltipParts.length > 0 ? tooltipParts.join('<br>') : 'Sem detalhamento de categoria';
                return `<tr class="hover:bg-slate-700"><td class="px-4 py-2"><a href="#" class="text-teal-400 hover:underline" data-codcli="${data['Código']}">${data['Código']}</a></td><td class="px-4 py-2 flex items-center">${data.fantasia || data.razaoSocial}${novoLabel}</td><td class="px-4 py-2 text-right"><div class="tooltip">${data.total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}<span class="tooltip-text" style="width: max-content; transform: translateX(-50%); margin-left: 0;">${tooltipText}</span></div></td><td class="px-4 py-2">${data.cidade}</td><td class="px-4 py-2">${data.bairro}</td><td class="px-4 py-2">${data.rcas[0] || '-'}</td></tr>`
            }).join('');

            inactiveClientsList.sort((a, b) => {
                if (a.isReturn && !b.isReturn) return -1;
                if (!a.isReturn && b.isReturn) return 1;
                if (a.isNewForInactiveLabel && !b.isNewForInactiveLabel) return -1;
                if (!a.isNewForInactiveLabel && b.isNewForInactiveLabel) return 1;
                return (parseDate(b.ultimaCompra) || 0) - (parseDate(a.ultimaCompra) || 0);
            });
            cityInactiveDetailTableBody.innerHTML = inactiveClientsList.map(client => {
                const novoLabel = client.isNewForInactiveLabel ? `<span class="ml-2 text-xs font-semibold text-purple-400 bg-purple-900/50 px-2 py-0.5 rounded-full">NOVO</span>` : '';
                const devolucaoLabel = client.isReturn ? `<span class="ml-2 text-xs font-semibold text-red-400 bg-red-900/50 px-2 py-0.5 rounded-full">DEVOLUÇÃO</span>` : '';
                return `<tr class="hover:bg-slate-700"><td class="px-4 py-2"><a href="#" class="text-teal-400 hover:underline" data-codcli="${client['Código']}">${client['Código']}</a></td><td class="px-4 py-2 flex items-center">${client.fantasia || client.razaoSocial}${novoLabel}${devolucaoLabel}</td><td class="px-4 py-2">${client.cidade}</td><td class="px-4 py-2">${client.bairro}</td><td class="px-4 py-2 text-center">${formatDate(client.ultimaCompra)}</td><td class="px-4 py-2">${client.rcas[0] || '-'}</td></tr>`
            }).join('');

            const cityChartTitleEl = document.getElementById('city-chart-title');
            const cityChartOptions = { indexAxis: 'y', scales: { x: { grace: '15%' } }, plugins: { datalabels: { align: 'end', anchor: 'end', color: '#cbd5e1', font: { size: 14, weight: 'bold' }, formatter: (value) => (value / 1000).toFixed(1) + 'k', offset: 8 } } };
            const totalFaturamentoCidade = salesForAnalysis.reduce((sum, item) => sum + item.VLVENDA, 0);
            totalFaturamentoCidadeEl.textContent = totalFaturamentoCidade.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            if (cidadeFiltro) {
                cityChartTitleEl.textContent = 'Top 10 Bairros';
                const salesByBairro = {};
                salesForAnalysis.forEach(sale => { const bairro = sale.BAIRRO || 'N/A'; salesByBairro[bairro] = (salesByBairro[bairro] || 0) + sale.VLVENDA; });
                const sortedBairros = Object.entries(salesByBairro).sort(([, a], [, b]) => b - a).slice(0, 10);
                createChart('salesByClientInCityChart', 'bar', sortedBairros.map(([name]) => name), sortedBairros.map(([, total]) => total), cityChartOptions);
            } else {
                cityChartTitleEl.textContent = 'Top 10 Cidades';
                const salesByCity = {};
                salesForAnalysis.forEach(sale => { const cidade = sale.CIDADE || 'N/A'; salesByCity[cidade] = (salesByCity[cidade] || 0) + sale.VLVENDA; });
                const sortedCidades = Object.entries(salesByCity).sort(([, a], [, b]) => b - a).slice(0, 10);
                createChart('salesByClientInCityChart', 'bar', sortedCidades.map(([name]) => name), sortedCidades.map(([, total]) => total), cityChartOptions);
            }
        }
